---
interface Heading {
	depth: number;
	slug: string;
	text: string;
}

interface Props {
	headings: Heading[];
}

const { headings } = Astro.props;

// Filter to only h2 and h3 for cleaner TOC
const filteredHeadings = headings.filter((h) => h.depth >= 2 && h.depth <= 3);
---

{filteredHeadings.length > 0 && (
	<nav class="toc" aria-label="Table of contents">
		{filteredHeadings.map((heading) => (
			<a
				href={`#${heading.slug}`}
				data-slug={heading.slug}
				class={`toc-link depth-${heading.depth}`}
			/>
		))}
	</nav>
)}

<script>
	function initTOC() {
		const tocLinks = document.querySelectorAll('.toc-link');

		if (tocLinks.length === 0) return;

		const headings = Array.from(tocLinks).map(link => {
			const slug = link.getAttribute('data-slug');
			return document.getElementById(slug || '');
		}).filter(Boolean) as HTMLElement[];

		if (headings.length === 0) return;

		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach(entry => {
					const id = entry.target.id;
					const link = document.querySelector(`.toc-link[data-slug="${id}"]`);
					if (entry.isIntersecting) {
						tocLinks.forEach(l => l.classList.remove('is-active'));
						link?.classList.add('is-active');
					}
				});
			},
			{ rootMargin: '-80px 0px -70% 0px' }
		);

		headings.forEach(heading => observer.observe(heading));
	}

	initTOC();
	document.addEventListener('astro:after-swap', initTOC);
</script>

<style>
	.toc {
		position: fixed;
		left: 1.5rem;
		top: 50%;
		transform: translateY(-50%);
		display: flex;
		flex-direction: column;
		gap: 4px;
		z-index: 100;
	}

	.toc-link {
		display: block;
		width: 12px;
		height: 2px;
		background: var(--muted);
		opacity: 0.3;
		transition: opacity 0.2s, width 0.2s;
	}

	.toc-link:hover {
		opacity: 0.6;
		background: var(--muted);
	}

	.toc-link.is-active {
		opacity: 1;
		background: var(--fg);
		width: 20px;
	}

	.toc-link.depth-3 {
		width: 8px;
		margin-left: 4px;
	}

	.toc-link.depth-3.is-active {
		width: 16px;
	}

	@media (max-width: 1100px) {
		.toc {
			display: none;
		}
	}
</style>
