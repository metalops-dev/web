---
import { type CollectionEntry, getCollection, render } from "astro:content";
import BlogPost from "../../layouts/BlogPost.astro";

export async function getStaticPaths() {
	const allPosts = await getCollection("blog");
	const posts = import.meta.env.PROD
		? allPosts.filter((post) => !post.data.draft)
		: allPosts;
	const sortedPosts = posts.sort(
		(a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
	);

	return sortedPosts.map((post, index) => ({
		params: { slug: post.id },
		props: {
			post,
			prev:
				index < sortedPosts.length - 1
					? {
							title: sortedPosts[index + 1].data.title,
							slug: sortedPosts[index + 1].id,
						}
					: undefined,
			next:
				index > 0
					? {
							title: sortedPosts[index - 1].data.title,
							slug: sortedPosts[index - 1].id,
						}
					: undefined,
		},
	}));
}

interface Props {
	post: CollectionEntry<"blog">;
	prev?: { title: string; slug: string };
	next?: { title: string; slug: string };
}

const { post, prev, next } = Astro.props;
const { Content, headings } = await render(post);
---

<BlogPost
	{...post.data}
	headings={headings}
	content={post.body || ''}
	prev={prev}
	next={next}
>
	<Content />
</BlogPost>
